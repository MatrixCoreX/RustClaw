# TODO: 多语言归一化增强硬路由（待实现）

## 背景

当前硬路由关键词命中主要依赖字符串包含匹配。  
当用户使用非中文/英文表达（如西语、日语、韩语等）时，即使语义上是“生图/改图/识图”，也可能无法命中硬路由关键词。

## 目标

在不改变现有路由主流程稳定性的前提下，增加“多语言语义归一化”步骤，提升硬路由在多语言输入下的命中率。

## 非目标

- 不替换现有 LLM 主路由（`chat/act/chat_act`）机制。
- 不移除现有关键词文件配置（`configs/routing/keywords.toml`）。
- 不在第一版引入复杂缓存系统（可后续迭代）。

## 方案概述（拟）

1. 新增可选开关：启用“路由归一化”。
2. 在硬路由判定前，调用一次轻量 LLM，将用户请求归一化为简短中/英语义短句。
3. 用“原始请求 + 归一化文本”共同参与关键词匹配。
4. 若 LLM 失败/超时/空结果，自动回退到“仅原始请求”匹配（不影响现有可用性）。

## 配置建议（拟）

在 `[routing]` 增加以下字段（默认建议）：

- `normalize_before_hard_route = false`
- `normalize_timeout_ms = 1200`
- `normalize_max_chars = 300`
- `normalize_model = ""`（为空时复用当前主模型）

## 提示词文件（拟）

新增：`prompts/routing_normalize_prompt.md`

要求：

- 输入：用户原文
- 输出：仅返回 JSON，例如：
  - `{"normalized":"请帮我生成一张图片"}`
- 约束：
  - 仅做路由语义归一化，不做回答
  - 不扩写，不添加新任务
  - 最长 N 字符（由配置控制）

## 实现要点（拟）

- 在 `clawd` 的硬路由判定入口添加归一化调用点。
- 匹配逻辑改为：
  - `match(original_text) || match(normalized_text)`
- 增加日志字段（便于排障）：
  - `routing_normalized_used`
  - `routing_normalized_preview`
  - `routing_normalize_latency_ms`

## 风险与应对

- 风险：额外一次 LLM 调用带来延迟  
  - 应对：短超时 + 失败快速回退
- 风险：归一化误导关键词命中  
  - 应对：限制提示词，只做“保守归一化”，并保留原始文本联合匹配
- 风险：成本上升  
  - 应对：默认关闭，仅按需开启

## 验收标准（拟）

- 开关关闭时：行为与当前版本一致。
- 开关开启时：至少覆盖 3 种非中英语言输入下的图片任务硬路由命中。
- LLM 失败/超时时：不影响请求处理，自动回退。
- 日志可观测归一化是否生效及耗时。

## 待办清单

- [ ] 设计配置字段并接入 `claw-core` 配置结构
- [ ] 增加 `prompts/routing_normalize_prompt.md`
- [ ] 实现归一化调用与回退逻辑
- [ ] 接入日志与基础指标
- [ ] 增加最小回归测试（开关开/关）
